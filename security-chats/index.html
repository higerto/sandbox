<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Security Chats</title>
    <!-- Favicon (–ª–æ–≥–æ—Ç–∏–ø –≤–∫–ª–∞–¥–∫–∏) -->
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-color: #1a1a2e;
            --container-bg: #16213e;
            --accent-color: #6a4c9c;
            --accent-light: #8a6cc9;
            --text-color: #e0e0e0;
            --border-color: #2a3a5e;
            --header-bg: #0f3460;
            --my-message-bg: #5d4e8c;
            --other-message-bg: #2d4059;
            --date-divider-bg: #1e2b3a;
            --input-bg: #2b3138;
            --icon-color: #b8b8ff;
            --emoji-panel-bg: #1e2a3a;
            --reaction-bg: rgba(255,255,255,0.1);
            --scroll-thumb: rgba(138, 108, 201, 0.6);
            --scroll-track: rgba(106, 76, 156, 0.2);
        }

        /* –ö—Ä–∞—Å–∏–≤–∞—è –ø–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scroll-track);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scroll-thumb);
            border-radius: 8px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-light);
        }
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-thumb) var(--scroll-track);
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
        }

        #login-screen {
            padding: 40px 20px;
            justify-content: center;
            align-items: center;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 500px;
        }

        #login-screen h2 {
            color: var(--accent-light);
            margin-bottom: 30px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus {
            border-color: var(--accent-color);
        }

        button {
            width: 100%;
            padding: 15px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s, background 0.2s;
        }

        button:hover {
            background: var(--accent-light);
        }

        button:active {
            opacity: 0.7;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #chat-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            background: var(--container-bg);
            position: relative;
        }

        /* –®–∏—Ä–æ–∫–∏–µ —ç–∫—Ä–∞–Ω—ã - —É–±–∏—Ä–∞–µ–º –±–æ–∫–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è */
        @media (min-width: 600px) {
            #chat-screen {
                max-width: none;
                width: 100%;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            .msg-wrapper {
                max-width: 95%; /* —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏–π */
            }
        }

        .header {
            padding: 10px 15px;
            background: var(--header-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 20;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-placeholder {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .logo-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px 4px 6px;
            border-radius: 30px;
            cursor: pointer;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid var(--accent-light);
        }

        .user-avatar svg {
            width: 22px;
            height: 22px;
            stroke: white;
            fill: none;
        }

        #display-name {
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 14px;
            color: var(--text-color);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--icon-color);
            padding: 6px;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .icon-btn svg {
            width: 22px;
            height: 22px;
            stroke: currentColor;
            fill: none;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.15);
        }

        .icon-btn:active {
            background: rgba(255,255,255,0.25);
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--bg-color);
        }

        .date-divider {
            text-align: center;
            margin: 10px 0;
            position: relative;
        }
        .date-divider span {
            background: var(--date-divider-bg);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #ccc;
            display: inline-block;
        }

        .msg-wrapper {
            display: flex;
            gap: 8px;
            max-width: 85%; /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –Ω–æ –Ω–∞ —à–∏—Ä–æ–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤—ã—à–µ */
        }

        .msg-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--accent-color);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid var(--accent-light);
        }

        .msg-avatar svg {
            width: 24px;
            height: 24px;
            stroke: white;
            fill: none;
        }

        .msg-content {
            flex: 1;
        }

        .msg-item {
            padding: 8px 12px;
            border-radius: 12px;
            word-wrap: break-word;
            background: var(--other-message-bg);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: filter 0.1s;
        }
        .msg-item:hover {
            filter: brightness(1.1);
        }

        .my-message .msg-item {
            background: var(--my-message-bg);
            border-bottom-right-radius: 4px;
            border-bottom-left-radius: 12px;
        }

        .msg-author {
            font-size: 13px;
            font-weight: bold;
            color: var(--accent-light);
            margin-bottom: 4px;
        }

        .file-message {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .preview-container img,
        .preview-container video {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            background: #000;
            border-radius: 8px;
            cursor: pointer;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .file-link {
            background: var(--accent-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .timestamp {
            font-size: 11px;
            color: #8696a0;
            margin-top: 4px;
            text-align: right;
        }

        /* –†–µ–∞–∫—Ü–∏–∏ */
        .reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }
        .reaction {
            background: var(--reaction-bg);
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #ddd;
            border: 1px solid var(--border-color);
        }
        .reaction span {
            font-size: 14px;
        }
        .reaction .count {
            font-size: 12px;
            color: var(--accent-light);
        }

        /* –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ ‚Äì –≤—Å—ë –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
        .input-area {
            padding: 8px 12px;
            background: var(--header-bg);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
            position: relative;
        }

        #msgInput {
            margin: 0;
            flex: 1 1 auto;
            background: var(--input-bg);
            border: none;
            padding: 12px 16px;
            font-size: 16px;
            color: white;
            border-radius: 40px;
            height: 48px;
            min-width: 100px;
        }

        .input-btn {
            background: transparent;
            border: none;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--accent-color);
            transition: background 0.2s, color 0.2s;
            flex-shrink: 0;
        }

        .input-btn svg {
            width: 30px;
            height: 30px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .input-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--accent-light);
        }

        .voice-btn.recording {
            color: #ff4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .send-btn {
            background: var(--accent-color);
            border: none;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .send-btn svg {
            width: 30px;
            height: 30px;
            stroke: currentColor;
            fill: none;
        }

        .send-btn:hover {
            background: var(--accent-light);
        }

        /* –ü–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏ */
        .emoji-panel {
            display: none;
            position: absolute;
            bottom: 70px;
            left: 10px;
            background: var(--emoji-panel-bg);
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 30;
            max-width: 340px;
            flex-wrap: wrap;
            gap: 8px;
            border: 1px solid var(--border-color);
        }

        .emoji-panel span {
            font-size: 32px;
            cursor: pointer;
            transition: transform 0.1s;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .emoji-panel span:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.2);
        }

        #compressStatus {
            display: none;
            background: #2b3138;
            color: #ffaa00;
            padding: 4px 10px;
            font-size: 12px;
            text-align: center;
        }

        #avatarInput {
            display: none;
        }
    </style>
</head>
<body>

<div id="login-screen">
    <h2>Security Chats</h2>
    <input type="text" id="userName" placeholder="User name: ">
    <input type="password" id="seedPhrase" placeholder="Chat key: ">
    <button onclick="enterChat()">Enter the chat</button>
</div>

<div id="chat-screen">
    <div class="header">
        <div class="header-left">
            <div class="logo-placeholder">
                <img src="logo.png" alt="logo">
            </div>
            <div class="user-info" onclick="changeAvatar()">
                <div class="user-avatar" id="headerAvatar">
                    <!-- –ë—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω –∞–≤–∞—Ç–∞—Ä –∏–ª–∏ –∏–∫–æ–Ω–∫–∞ -->
                </div>
                <span id="display-name"></span>
            </div>
        </div>
        <div class="action-buttons">
            <button class="icon-btn" onclick="loadMessages()" title="–û–±–Ω–æ–≤–∏—Ç—å">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                    <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                    <path d="M21 21v-5h-5"/>
                </svg>
            </button>
            <button class="icon-btn" onclick="exportChat()" title="–≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            </button>
            <button class="icon-btn" onclick="resetChat()" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            </button>
        </div>
    </div>

    <div id="messages"></div>

    <div class="input-area">
        <!-- –£–±—Ä–∞–ª–∏ accept, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±–∏—Ä–∞—Ç—å –ª—é–±—ã–µ —Ñ–∞–π–ª—ã, –≤–∫–ª—é—á–∞—è –∞—Ä—Ö–∏–≤—ã -->
        <input type="file" id="fileInput" style="display:none;" multiple>
        <!-- –ö–Ω–æ–ø–∫–∞ –≤–ª–æ–∂–µ–Ω–∏—è (—Å–∫—Ä–µ–ø–∫–∞) —É–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è -->
        <button class="input-btn" onclick="document.getElementById('fileInput').click()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã (–¥–æ 10 –ú–ë, –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ —É–ø–∞–∫—É—é—Ç—Å—è –≤ ZIP)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
            </svg>
        </button>
        <!-- –ö–Ω–æ–ø–∫–∞ —ç–º–æ–¥–∑–∏ —É–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è -->
        <button class="input-btn" id="emojiBtn" onclick="toggleEmojiPanel()" title="–≠–º–æ–¥–∑–∏">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                <line x1="9" y1="9" x2="9.01" y2="9"/>
                <line x1="15" y1="9" x2="15.01" y2="9"/>
            </svg>
        </button>
        <!-- –ü–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–≤–æ–¥–∞ (–±–æ–ª—å—à–µ —ç–º–æ–¥–∑–∏) -->
        <div id="emojiPanel" class="emoji-panel">
            <span onclick="addEmoji('üòä')">üòä</span>
            <span onclick="addEmoji('üòÇ')">üòÇ</span>
            <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="addEmoji('üëç')">üëç</span>
            <span onclick="addEmoji('üò¢')">üò¢</span>
            <span onclick="addEmoji('üòé')">üòé</span>
            <span onclick="addEmoji('üî•')">üî•</span>
            <span onclick="addEmoji('üéâ')">üéâ</span>
            <span onclick="addEmoji('ü§î')">ü§î</span>
            <span onclick="addEmoji('üëã')">üëã</span>
            <span onclick="addEmoji('üôè')">üôè</span>
            <span onclick="addEmoji('üíØ')">üíØ</span>
            <span onclick="addEmoji('‚≠ê')">‚≠ê</span>
            <span onclick="addEmoji('üçï')">üçï</span>
            <span onclick="addEmoji('üé∂')">üé∂</span>
            <span onclick="addEmoji('üê±')">üê±</span>
        </div>
        <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–º–∏–∫—Ä–æ—Ñ–æ–Ω) —É–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è -->
        <button class="input-btn voice-btn" id="voiceBtn" onclick="toggleRecording()" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
        </button>
        <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <button class="send-btn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
        </button>
    </div>
    <div id="compressStatus">‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞...</div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ -->
<input type="file" id="avatarInput" accept="image/*">

<!-- –ü–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π (–±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ) -->
<div id="reactionPanel" class="emoji-panel reaction-panel" style="display: none;">
    <span onclick="addReactionToSelected('üòä')">üòä</span>
    <span onclick="addReactionToSelected('üòÇ')">üòÇ</span>
    <span onclick="addReactionToSelected('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    <span onclick="addReactionToSelected('üëç')">üëç</span>
    <span onclick="addReactionToSelected('üò¢')">üò¢</span>
    <span onclick="addReactionToSelected('üòé')">üòé</span>
    <span onclick="addReactionToSelected('üî•')">üî•</span>
    <span onclick="addReactionToSelected('üéâ')">üéâ</span>
    <span onclick="addReactionToSelected('ü§î')">ü§î</span>
    <span onclick="addReactionToSelected('üëÄ')">üëÄ</span>
    <span onclick="addReactionToSelected('üíÄ')">üíÄ</span>
    <span onclick="addReactionToSelected('üí©')">üí©</span>
    <span onclick="addReactionToSelected('üåü')">üåü</span>
    <span onclick="addReactionToSelected('üçå')">üçå</span>
    <span onclick="addReactionToSelected('‚ö°')">‚ö°</span>
    <span onclick="addReactionToSelected('‚úÖ')">‚úÖ</span>
</div>

<script>
    // ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================
    var GITHUB_TOKEN = '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';   // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π
    var GIST_ID = '06a05c36520ef604f23bbea75fff0679';      // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π
    const FILE_NAME = 'txt';
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 –ú–ë –ø–æ—Å–ª–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

    let currentUser = '';
    let currentSeed = '';
    let refreshInterval = null;
    let currentUserAvatar = null;
    let selectedMessageForReaction = null;

    // ================== –ê–í–ê–¢–ê–†–´ ==================
    document.getElementById('avatarInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            return;
        }
        const avatarBase64 = await resizeImage(file, 100, 100, 0.8);
        localStorage.setItem(`avatar_${currentUser}`, avatarBase64);
        currentUserAvatar = avatarBase64;
        updateHeaderAvatar();
        e.target.value = '';
    });

    function resizeImage(file, maxWidth, maxHeight, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = Math.round((width * maxHeight) / height);
                            height = maxHeight;
                        }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function updateHeaderAvatar() {
        const headerAvatarDiv = document.getElementById('headerAvatar');
        const savedAvatar = localStorage.getItem(`avatar_${currentUser}`);
        if (savedAvatar) {
            headerAvatarDiv.innerHTML = `<img src="${savedAvatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
        } else {
            const initials = currentUser ? currentUser.substring(0, 2).toUpperCase() : '?';
            headerAvatarDiv.innerHTML = `<span style="font-size:16px; font-weight:bold;">${initials}</span>`;
        }
    }

    function changeAvatar() {
        document.getElementById('avatarInput').click();
    }

    // ================== –ó–ê–ü–ò–°–¨ –ì–û–õ–û–°–ê ==================
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    async function toggleRecording() {
        const voiceBtn = document.getElementById('voiceBtn');
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendVoiceMessage(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                voiceBtn.classList.add('recording');
                voiceBtn.title = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
            } catch (err) {
                alert('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                console.error(err);
            }
        } else {
            mediaRecorder.stop();
            isRecording = false;
            voiceBtn.classList.remove('recording');
            voiceBtn.title = '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
        }
    }

    async function sendVoiceMessage(blob) {
        const file = new File([blob], `voice_${Date.now()}.webm`, { type: 'audio/webm' });
        await processAndSendFile(file);
    }

    // ================== –û–¢–ü–†–ê–í–ö–ê –¢–ï–ö–°–¢–ê ==================
    async function sendMessage() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if (!text) return;

        const messageObj = {
            type: 'text',
            user: currentUser,
            text: text,
            time: Date.now(),
            avatar: currentUserAvatar || null,
            reactions: []
        };
        const jsonStr = JSON.stringify(messageObj);
        const encrypted = CryptoJS.AES.encrypt(jsonStr, currentSeed).toString();

        input.value = '';
        await postEncryptedMessage(encrypted);
    }

    // ================== –û–ë–†–ê–ë–û–¢–ö–ê –§–ê–ô–õ–û–í (–≤ —Ç–æ–º —á–∏—Å–ª–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö) ==================
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        const statusDiv = document.getElementById('compressStatus');
        statusDiv.style.display = 'block';

        try {
            if (files.length === 1) {
                // –û–¥–∏–Ω–æ—á–Ω—ã–π —Ñ–∞–π–ª ‚Äì –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
                await processAndSendFile(files[0]);
            } else {
                // –ù–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ ‚Äì —Å–æ–∑–¥–∞—ë–º ZIP
                statusDiv.innerText = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
                const zipFile = await createZipFromFiles(files);
                statusDiv.innerText = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞...';
                await processAndSendFile(zipFile);
            }
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–æ–≤:', err);
            alert('–û—à–∏–±–∫–∞: ' + err.message);
        } finally {
            statusDiv.style.display = 'none';
            statusDiv.innerText = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞...'; // –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç
            e.target.value = '';
        }
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ ZIP-–∞—Ä—Ö–∏–≤–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
    async function createZipFromFiles(files) {
        const zip = new JSZip();
        for (let file of files) {
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤ –∫–æ—Ä–µ–Ω—å –∞—Ä—Ö–∏–≤–∞
            zip.file(file.name, file);
        }
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const zipFile = new File([zipBlob], 'archive.zip', { type: 'application/zip' });
        return zipFile;
    }

    async function processAndSendFile(file) {
        if (file.size > 10 * 1024 * 1024) {
            throw new Error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)');
        }

        let processedFile = file;

        // –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–∏–¥–µ–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, –∞—Ä—Ö–∏–≤—ã –Ω–µ —Å–∂–∏–º–∞–µ–º)
        if (file.type.startsWith('image/')) {
            processedFile = await compressImageToWebP(file);
        } else if (file.type.startsWith('video/')) {
            processedFile = await compressVideo(file);
        }

        const base64Data = await readFileAsBase64(processedFile);

        const fileObject = {
            type: 'file',
            user: currentUser,
            name: processedFile.name,
            mime: processedFile.type || 'application/octet-stream',
            size: processedFile.size,
            data: base64Data,
            time: Date.now(),
            avatar: currentUserAvatar || null,
            reactions: []
        };

        const jsonStr = JSON.stringify(fileObject);
        const encrypted = CryptoJS.AES.encrypt(jsonStr, currentSeed).toString();

        if (encrypted.length > MAX_FILE_SIZE) {
            throw new Error('–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç 5 –ú–ë');
        }

        await postEncryptedMessage(encrypted);
    }

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function compressImageToWebP(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    const maxDim = 1280;
                    if (width > height && width > maxDim) {
                        height = Math.round((height * maxDim) / width);
                        width = maxDim;
                    } else if (height > maxDim) {
                        width = Math.round((width * maxDim) / height);
                        height = maxDim;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        if (!blob) {
                            reject(new Error('–û—à–∏–±–∫–∞ —Å–∂–∞—Ç–∏—è WebP'));
                            return;
                        }
                        const newFile = new File([blob], file.name.replace(/\.[^/.]+$/, '.webp'), { type: 'image/webp' });
                        resolve(newFile);
                    }, 'image/webp', 0.85);
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function compressVideo(file) {
        return new Promise(async (resolve, reject) => {
            try {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.src = URL.createObjectURL(file);
                await new Promise((r) => { video.onloadedmetadata = r; });

                const hasAudio = video.mozHasAudio || video.webkitAudioContext || (video.audioTracks && video.audioTracks.length > 0);
                
                if (!hasAudio) {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const width = Math.min(video.videoWidth, 480);
                    const height = Math.min(video.videoHeight, 360);
                    canvas.width = width;
                    canvas.height = height;

                    video.currentTime = Math.min(1, video.duration / 2);
                    await new Promise((r) => { video.onseeked = r; });
                    ctx.drawImage(video, 0, 0, width, height);
                    canvas.toBlob((blob) => {
                        const newFile = new File([blob], file.name.replace(/\.[^/.]+$/, '.webp'), { type: 'image/webp' });
                        resolve(newFile);
                    }, 'image/webp', 0.8);
                } else {
                    console.warn('–í–∏–¥–µ–æ —Å–æ –∑–≤—É–∫–æ–º ‚Äì –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª (–±–µ–∑ —Å–∂–∞—Ç–∏—è)');
                    resolve(file);
                }
                URL.revokeObjectURL(video.src);
            } catch (e) {
                reject(e);
            }
        });
    }

    // ================== –û–¢–ü–†–ê–í–ö–ê –í GIST ==================
    async function postEncryptedMessage(encryptedText) {
        try {
            const getResp = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            if (!getResp.ok) throw new Error(`GET ${getResp.status}: ${await getResp.text()}`);
            const getData = await getResp.json();

            const oldContent = getData.files[FILE_NAME]?.content || '';
            const separator = oldContent && !oldContent.endsWith('\n') ? '\n' : '';
            const newContent = oldContent + separator + encryptedText;

            const patchResp = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: { [FILE_NAME]: { content: newContent } }
                })
            });
            if (!patchResp.ok) throw new Error(`PATCH ${patchResp.status}: ${await patchResp.text()}`);

            loadMessages();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + err.message);
        }
    }

    // ================== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==================
    async function loadMessages() {
        const msgDiv = document.getElementById('messages');
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}?t=${Date.now()}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            
            const content = data.files[FILE_NAME]?.content || '';
            const lines = content.split('\n').filter(line => line.trim() !== '');
            
            const messages = [];
            for (let line of lines) {
                try {
                    const bytes = CryptoJS.AES.decrypt(line, currentSeed);
                    const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                    if (decrypted) {
                        const msg = JSON.parse(decrypted);
                        if (!msg.reactions) msg.reactions = [];
                        messages.push(msg);
                    }
                } catch (e) {}
            }

            messages.sort((a, b) => (a.time || 0) - (b.time || 0));

            msgDiv.innerHTML = '';
            let lastDate = null;

            for (let msg of messages) {
                const msgDate = msg.time ? new Date(msg.time).toLocaleDateString() : null;
                if (msgDate && msgDate !== lastDate) {
                    lastDate = msgDate;
                    const divider = document.createElement('div');
                    divider.className = 'date-divider';
                    divider.innerHTML = `<span>${msgDate}</span>`;
                    msgDiv.appendChild(divider);
                }
                displayMessage(msg, msgDiv);
            }

            msgDiv.scrollTop = msgDiv.scrollHeight;
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
            msgDiv.innerHTML = '<center>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</center>';
        }
    }

    // ================== –û–¢–†–ò–°–û–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ==================
    function displayMessage(msg, container) {
        const wrapper = document.createElement('div');
        wrapper.className = 'msg-wrapper';
        if (msg.user === currentUser) {
            wrapper.style.alignSelf = 'flex-end';
        }

        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'msg-avatar';
        if (msg.avatar) {
            avatarDiv.innerHTML = `<img src="${msg.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
        } else {
            const initials = msg.user ? msg.user.substring(0, 2).toUpperCase() : '?';
            avatarDiv.innerHTML = `<span style="font-size:14px; font-weight:bold;">${initials}</span>`;
        }
        wrapper.appendChild(avatarDiv);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'msg-content';

        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg-item';
        msgDiv.setAttribute('data-time', msg.time);
        msgDiv.setAttribute('data-user', msg.user);
        msgDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            showReactionPanel(msg, e.clientX, e.clientY);
        });

        if (msg.user === currentUser) {
            msgDiv.classList.add('my-message');
        }

        if (msg.user && msg.user !== currentUser) {
            const authorDiv = document.createElement('div');
            authorDiv.className = 'msg-author';
            authorDiv.textContent = msg.user;
            msgDiv.appendChild(authorDiv);
        }

        if (msg.type === 'file') {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-message';

            const binary = atob(msg.data);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
            const blob = new Blob([array], { type: msg.mime });
            const url = URL.createObjectURL(blob);

            if (msg.mime.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = url;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '200px';
                img.style.borderRadius = '8px';
                img.style.cursor = 'pointer';
                img.onclick = (e) => {
                    e.stopPropagation();
                    window.open(url, '_blank');
                };
                fileDiv.appendChild(img);
            } else if (msg.mime.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '200px';
                fileDiv.appendChild(video);
            } else if (msg.mime.startsWith('audio/')) {
                const audio = document.createElement('audio');
                audio.src = url;
                audio.controls = true;
                audio.style.width = '100%';
                fileDiv.appendChild(audio);
            }

            const infoDiv = document.createElement('div');
            infoDiv.className = 'file-info';
            infoDiv.innerHTML = `
                <span>üìé ${msg.name} (${formatSize(msg.size)})</span>
                <a href="${url}" download="${msg.name.replace(/["']/g, '_')}" class="file-link">–°–∫–∞—á–∞—Ç—å</a>
            `;
            fileDiv.appendChild(infoDiv);
            msgDiv.appendChild(fileDiv);
        } else {
            msgDiv.appendChild(document.createTextNode(msg.text || msg));
        }

        if (msg.time) {
            const timeSpan = document.createElement('div');
            timeSpan.className = 'timestamp';
            timeSpan.textContent = new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            msgDiv.appendChild(timeSpan);
        }

        contentDiv.appendChild(msgDiv);

        if (msg.reactions && msg.reactions.length > 0) {
            const reactionsDiv = document.createElement('div');
            reactionsDiv.className = 'reactions';
            const grouped = {};
            msg.reactions.forEach(r => {
                if (!grouped[r.reaction]) grouped[r.reaction] = [];
                grouped[r.reaction].push(r.user);
            });
            for (let [emoji, users] of Object.entries(grouped)) {
                const reactionSpan = document.createElement('span');
                reactionSpan.className = 'reaction';
                reactionSpan.innerHTML = `<span>${emoji}</span><span class="count">${users.length}</span>`;
                reactionsDiv.appendChild(reactionSpan);
            }
            contentDiv.appendChild(reactionsDiv);
        }

        wrapper.appendChild(contentDiv);
        container.appendChild(wrapper);
    }

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // ================== –†–ï–ê–ö–¶–ò–ò ==================
    let selectedMsg = null;

    function showReactionPanel(msg, x, y) {
        selectedMsg = msg;
        const panel = document.getElementById('reactionPanel');
        panel.style.display = 'flex';
        panel.style.left = (x - 100) + 'px';
        panel.style.top = (y - 40) + 'px';
        document.getElementById('emojiPanel').style.display = 'none';
    }

    function addReactionToSelected(emoji) {
        if (!selectedMsg) return;
        const existingIndex = selectedMsg.reactions.findIndex(r => r.user === currentUser && r.reaction === emoji);
        if (existingIndex !== -1) {
            selectedMsg.reactions.splice(existingIndex, 1);
        } else {
            const userReactionIndex = selectedMsg.reactions.findIndex(r => r.user === currentUser);
            if (userReactionIndex !== -1) {
                selectedMsg.reactions.splice(userReactionIndex, 1);
            }
            selectedMsg.reactions.push({ user: currentUser, reaction: emoji });
        }
        updateMessageInGist(selectedMsg);
        document.getElementById('reactionPanel').style.display = 'none';
        selectedMsg = null;
    }

    async function updateMessageInGist(updatedMsg) {
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            if (!response.ok) throw new Error(`GET ${response.status}`);
            const data = await response.json();
            const content = data.files[FILE_NAME]?.content || '';
            const lines = content.split('\n').filter(line => line.trim() !== '');

            const messages = [];
            for (let line of lines) {
                try {
                    const bytes = CryptoJS.AES.decrypt(line, currentSeed);
                    const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                    if (decrypted) {
                        const msg = JSON.parse(decrypted);
                        messages.push(msg);
                    }
                } catch (e) {}
            }

            const index = messages.findIndex(m => m.time === updatedMsg.time && m.user === updatedMsg.user);
            if (index === -1) return;

            messages[index] = updatedMsg;

            const newLines = [];
            for (let msg of messages) {
                const jsonStr = JSON.stringify(msg);
                const encrypted = CryptoJS.AES.encrypt(jsonStr, currentSeed).toString();
                newLines.push(encrypted);
            }
            const newContent = newLines.join('\n');

            const patchResp = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: { [FILE_NAME]: { content: newContent } }
                })
            });
            if (!patchResp.ok) throw new Error(`PATCH ${patchResp.status}`);

            loadMessages();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é');
        }
    }

    // ================== –≠–ú–û–î–ó–ò (–≤–≤–æ–¥) ==================
    function toggleEmojiPanel() {
        const panel = document.getElementById('emojiPanel');
        panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        document.getElementById('reactionPanel').style.display = 'none';
    }

    function addEmoji(emoji) {
        const input = document.getElementById('msgInput');
        input.value += emoji;
        input.focus();
    }

    document.addEventListener('click', function(e) {
        const emojiPanel = document.getElementById('emojiPanel');
        const reactionPanel = document.getElementById('reactionPanel');
        const emojiBtn = document.getElementById('emojiBtn');
        if (!emojiPanel.contains(e.target) && !emojiBtn.contains(e.target)) {
            emojiPanel.style.display = 'none';
        }
        if (!reactionPanel.contains(e.target) && !e.target.closest('.msg-item')) {
            reactionPanel.style.display = 'none';
            selectedMsg = null;
        }
    });

    // ================== –°–ë–†–û–° –ß–ê–¢–ê ==================
    async function resetChat() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
        try {
            await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: { [FILE_NAME]: { content: '' } }
                })
            });
            loadMessages();
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
        }
    }

    // ================== –≠–ö–°–ü–û–†–¢ –ò–°–¢–û–†–ò–ò ==================
    async function exportChat() {
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}?t=${Date.now()}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            const content = data.files[FILE_NAME]?.content || '';
            
            const lines = content.split('\n').filter(l => l.trim());
            let decryptedLines = [];

            for (let line of lines) {
                try {
                    const bytes = CryptoJS.AES.decrypt(line, currentSeed);
                    const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                    if (decrypted) {
                        try {
                            const parsed = JSON.parse(decrypted);
                            decryptedLines.push(JSON.stringify(parsed, null, 2));
                        } catch {
                            decryptedLines.push(decrypted);
                        }
                    }
                } catch (e) {}
            }

            if (decryptedLines.length === 0) {
                alert('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.');
                return;
            }

            const blob = new Blob([decryptedLines.join('\n\n')], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_export_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
        }
    }

    // ================== –í–•–û–î ==================
    function enterChat() {
        currentUser = document.getElementById('userName').value.trim();
        currentSeed = document.getElementById('seedPhrase').value.trim();

        if (!currentUser || !currentSeed) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–ª—é—á —á–∞—Ç–∞!");

        currentUserAvatar = localStorage.getItem(`avatar_${currentUser}`);
        updateHeaderAvatar();

        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('display-name').innerText = currentUser;

        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(loadMessages, 10000);
        
        loadMessages();
    }

    document.getElementById('msgInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });
</script>

</body>
</html>
